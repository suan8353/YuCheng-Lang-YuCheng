# 御程语言独有UI功能与测试系统

> **实现状态**: ⚠️ 部分实现
> - ✅ UI 解析器与渲染管线已实现（`compiler/src/ui/*`）
> - ✅ 响应式绑定、条件渲染、循环渲染、状态机、动画、主题、多语言、无障碍等核心能力已有初版实现
> - ✅ UI 测试基础能力已通过 `ui_testing` 与链路测试框架接入（如 `渲染界面`、`断言_存在` 等）
> - ⚠️ 文中部分高级 DSL 语法与全部测试辅助函数仍在逐步对齐中
> - 📋 本文档既是设计说明，也是当前实现的能力对照表

本文档定义了御程语言10个独有的UI构建功能及其对应的测试函数。

## 一、独有UI功能概览

| 序号 | 功能名称 | 中文关键字 | 说明 |
|------|----------|------------|------|
| 1 | 响应式绑定 | `绑定` | 双向数据绑定，自动更新UI |
| 2 | 条件渲染 | `若显示` | 基于条件的控件显示/隐藏 |
| 3 | 列表渲染 | `循环渲染` | 基于数据列表动态生成控件 |
| 4 | 状态机控件 | `状态机` | 基于状态的UI切换 |
| 5 | 动画声明 | `动画` | 声明式动画定义 |
| 6 | 主题系统 | `主题` | 全局主题和样式变量 |
| 7 | 插槽系统 | `插槽` | 组件内容分发 |
| 8 | 表单验证 | `验证` | 声明式表单验证规则 |
| 9 | 国际化 | `多语言` | 内置国际化支持 |
| 10 | 无障碍 | `无障碍` | 内置无障碍访问支持 |

---

## 二、功能详解与语法

### 1. 响应式绑定 (`绑定`)

**语法：**
```御程
窗口 {
    // 声明响应式状态
    状态 {
        计数: 0
        用户名: ""
        已登录: 假
    }
    
    // 使用绑定
    文本标签 { 内容: 绑定(计数) }
    文本框 { 值: 双向绑定(用户名) }
    按钮 { 
        文字: "增加"
        点击 => 更新状态(计数, 计数 + 1)
    }
}
```


### 2. 条件渲染 (`若显示`)

**语法：**
```御程
窗口 {
    状态 { 已登录: 假 }
    
    // 条件显示
    若显示(已登录) {
        文本标签 { 内容: "欢迎回来！" }
        按钮 { 文字: "退出" }
    }
    
    // 条件隐藏
    若隐藏(已登录) {
        文本框 { 提示文字: "用户名" }
        密码框 { 提示文字: "密码" }
        按钮 { 文字: "登录" }
    }
    
    // 条件切换
    若则(已登录) {
        文本标签 { 内容: "已登录" }
    } 否则 {
        文本标签 { 内容: "未登录" }
    }
}
```

### 3. 列表渲染 (`循环渲染`)

**语法：**
```御程
窗口 {
    状态 {
        用户列表: [
            { 姓名: "张三", 年龄: 25 },
            { 姓名: "李四", 年龄: 30 }
        ]
    }
    
    列表 {
        循环渲染(用户列表) 为 用户, 索引 {
            列表项 {
                文本标签 { 内容: 绑定(索引 + 1) }
                文本标签 { 内容: 绑定(用户.姓名) }
                文本标签 { 内容: 绑定(用户.年龄) }
                按钮 { 
                    文字: "删除"
                    点击 => 删除项(用户列表, 索引)
                }
            }
        }
    }
}
```

### 4. 状态机控件 (`状态机`)

**语法：**
```御程
窗口 {
    状态机 页面状态 {
        初始: "加载中"
        
        状态 "加载中" {
            加载指示器 { 大小: 48 }
            文本标签 { 内容: "正在加载..." }
        }
        
        状态 "成功" {
            文本标签 { 内容: "加载完成！" }
            按钮 { 文字: "继续" }
        }
        
        状态 "失败" {
            文本标签 { 内容: "加载失败" 字体颜色: "#f44336" }
            按钮 { 
                文字: "重试"
                点击 => 切换状态(页面状态, "加载中")
            }
        }
        
        转换 "加载中" -> "成功" 当 数据加载完成()
        转换 "加载中" -> "失败" 当 加载超时()
    }
}
```

### 5. 动画声明 (`动画`)

**语法：**
```御程
窗口 {
    // 定义动画
    动画 淡入 {
        从: { 透明度: 0 }
        到: { 透明度: 1 }
        时长: 300毫秒
        缓动: 渐出
    }
    
    动画 滑入 {
        从: { 位移X: -100 }
        到: { 位移X: 0 }
        时长: 500毫秒
        缓动: 弹性
    }
    
    动画 脉冲 {
        关键帧 0% { 缩放: 1 }
        关键帧 50% { 缩放: 1.1 }
        关键帧 100% { 缩放: 1 }
        时长: 1秒
        循环: 无限
    }
    
    // 使用动画
    卡片 {
        入场动画: 淡入
        悬停动画: 脉冲
        
        文本标签 { 内容: "动画卡片" }
    }
}
```


### 6. 主题系统 (`主题`)

**语法：**
```御程
// 定义主题
主题 亮色主题 {
    主色: "#1976D2"
    背景色: "#ffffff"
    文字色: "#333333"
    边框色: "#e0e0e0"
    成功色: "#4caf50"
    警告色: "#ff9800"
    错误色: "#f44336"
    
    字体: "Microsoft YaHei"
    圆角: 4像素
    阴影: "0 2px 8px rgba(0,0,0,0.1)"
}

主题 暗色主题 继承 亮色主题 {
    背景色: "#1e1e1e"
    文字色: "#e0e0e0"
    边框色: "#3c3c3c"
}

窗口 {
    应用主题: 亮色主题
    
    按钮 {
        文字: "主题按钮"
        背景色: 主题.主色
        文字颜色: 主题.背景色
    }
}
```

### 7. 插槽系统 (`插槽`)

**语法：**
```御程
// 定义可复用组件
组件 卡片模板 {
    参数 {
        标题: 文本
    }
    
    卡片 {
        布局_垂直 {
            // 头部插槽
            插槽 头部 {
                默认 {
                    文本标签 { 内容: 绑定(标题) 字体粗细: "粗体" }
                }
            }
            
            分隔线 {}
            
            // 内容插槽（必填）
            插槽 内容 必填
            
            // 底部插槽（可选）
            插槽 底部
        }
    }
}

// 使用组件
窗口 {
    卡片模板 {
        标题: "用户信息"
        
        填充插槽 头部 {
            布局_水平 {
                头像 { 文字: "张" }
                文本标签 { 内容: "张三的卡片" }
            }
        }
        
        填充插槽 内容 {
            文本标签 { 内容: "这是卡片内容" }
        }
        
        填充插槽 底部 {
            按钮 { 文字: "确定" }
            按钮 { 文字: "取消" }
        }
    }
}
```

### 8. 表单验证 (`验证`)

**语法：**
```御程
窗口 {
    表单 用户表单 {
        验证模式: 提交时  // 或 "实时" / "失焦时"
        
        表单项 {
            名称: "用户名"
            必填: 真
            
            文本框 用户名输入 {
                验证 {
                    规则 非空 { 消息: "用户名不能为空" }
                    规则 最小长度(3) { 消息: "用户名至少3个字符" }
                    规则 最大长度(20) { 消息: "用户名最多20个字符" }
                    规则 正则("^[a-zA-Z0-9_]+$") { 消息: "只能包含字母数字下划线" }
                }
            }
        }
        
        表单项 {
            名称: "邮箱"
            
            文本框 邮箱输入 {
                验证 {
                    规则 邮箱格式 { 消息: "请输入有效的邮箱地址" }
                }
            }
        }
        
        表单项 {
            名称: "密码"
            必填: 真
            
            密码框 密码输入 {
                验证 {
                    规则 非空 { 消息: "密码不能为空" }
                    规则 密码强度(中等) { 消息: "密码强度不足" }
                }
            }
        }
        
        表单项 {
            名称: "确认密码"
            
            密码框 确认密码输入 {
                验证 {
                    规则 匹配(密码输入) { 消息: "两次密码不一致" }
                }
            }
        }
        
        按钮 {
            文字: "提交"
            点击 => 提交表单(用户表单)
        }
    }
    
    // 表单事件
    当 用户表单.验证成功 {
        显示消息("注册成功！")
    }
    
    当 用户表单.验证失败 为 错误列表 {
        显示错误(错误列表)
    }
}
```


### 9. 国际化 (`多语言`)

**语法：**
```御程
// 定义语言包
语言包 中文 {
    欢迎: "欢迎使用御程"
    登录: "登录"
    注册: "注册"
    用户名: "用户名"
    密码: "密码"
    提交: "提交"
    取消: "取消"
    
    // 带参数的文本
    欢迎用户: "欢迎，{用户名}！"
    剩余次数: "您还有 {次数} 次机会"
}

语言包 英文 {
    欢迎: "Welcome to YuCheng"
    登录: "Login"
    注册: "Register"
    用户名: "Username"
    密码: "Password"
    提交: "Submit"
    取消: "Cancel"
    
    欢迎用户: "Welcome, {用户名}!"
    剩余次数: "You have {次数} chances left"
}

窗口 {
    当前语言: 中文
    
    文本标签 { 内容: 多语言(欢迎) }
    
    布局_水平 {
        按钮 { 文字: 多语言(登录) }
        按钮 { 文字: 多语言(注册) }
    }
    
    // 带参数
    文本标签 { 
        内容: 多语言(欢迎用户, 用户名: "张三") 
    }
    
    // 语言切换
    下拉选择 {
        选项: ["中文", "English"]
        变化 => 切换语言(选中值)
    }
}
```

### 10. 无障碍 (`无障碍`)

**语法：**
```御程
窗口 {
    无障碍 {
        角色: "应用程序"
        标签: "御程示例应用"
        描述: "这是一个演示无障碍功能的应用"
    }
    
    布局_垂直 {
        无障碍 { 角色: "导航" 标签: "主导航" }
        
        按钮 {
            文字: "🏠"
            无障碍 {
                标签: "返回首页"
                快捷键: "Alt+H"
                提示: "点击返回首页"
            }
        }
    }
    
    表单 {
        无障碍 { 角色: "表单" 标签: "登录表单" }
        
        表单项 {
            文本框 {
                无障碍 {
                    标签: "用户名输入框"
                    必填: 真
                    错误消息: 绑定(用户名错误)
                }
            }
        }
        
        按钮 {
            文字: "提交"
            无障碍 {
                标签: "提交登录表单"
                角色: "按钮"
                状态: 绑定(若(加载中, "忙碌", "正常"))
            }
        }
    }
    
    // 焦点管理
    焦点陷阱 对话框区域 {
        对话框 {
            // 焦点会被限制在对话框内
        }
    }
    
    // 屏幕阅读器公告
    公告区域 {
        实时: "礼貌"  // 或 "断言"
        内容: 绑定(状态消息)
    }
}
```

---

## 三、UI测试函数

御程语言提供了专门的UI测试函数，支持组件测试、交互测试和视觉测试。

### 3.1 组件存在性测试

```御程
#测试
纯函数 测试_按钮存在() {
    // 渲染组件
    渲染界面("login.ycv")
    
    // 断言组件存在
    断言_存在("登录按钮")
    断言_存在_多个("输入框", 2)
    断言_不存在("管理员面板")
}

#测试
纯函数 测试_条件渲染() {
    渲染界面("dashboard.ycv")
    
    // 初始状态
    断言_不存在("欢迎消息")
    
    // 模拟登录
    设置状态(已登录: 真, 用户名: "张三")
    
    // 验证条件渲染
    断言_存在("欢迎消息")
    断言_文本("欢迎消息", "欢迎，张三！")
}
```


### 3.2 交互测试

```御程
#测试
纯函数 测试_按钮点击() {
    渲染界面("counter.ycv")
    
    // 获取初始值
    变量 初始值 = 获取文本("计数显示")
    断言_等于(初始值, "0")
    
    // 模拟点击
    点击("增加按钮")
    
    // 验证更新
    断言_文本("计数显示", "1")
    
    // 多次点击
    点击("增加按钮", 次数: 5)
    断言_文本("计数显示", "6")
}

#测试
纯函数 测试_表单输入() {
    渲染界面("login.ycv")
    
    // 输入文本
    输入文本("用户名输入框", "testuser")
    输入文本("密码输入框", "password123")
    
    // 验证输入值
    断言_输入值("用户名输入框", "testuser")
    断言_输入值("密码输入框", "password123")
    
    // 清空输入
    清空输入("用户名输入框")
    断言_输入值("用户名输入框", "")
}

#测试
纯函数 测试_键盘交互() {
    渲染界面("search.ycv")
    
    // 聚焦输入框
    聚焦("搜索框")
    断言_已聚焦("搜索框")
    
    // 输入并按回车
    输入文本("搜索框", "御程语言")
    按键(回车)
    
    // 验证搜索触发
    断言_存在("搜索结果")
    
    // 测试快捷键
    按键组合(Ctrl, K)
    断言_已聚焦("搜索框")
}
```

### 3.3 状态测试

```御程
#测试
纯函数 测试_状态绑定() {
    渲染界面("reactive.ycv")
    
    // 验证初始状态
    断言_状态("计数", 0)
    断言_状态("用户名", "")
    
    // 修改状态
    设置状态(计数: 10)
    
    // 验证UI更新
    断言_文本("计数显示", "10")
    
    // 验证双向绑定
    输入文本("用户名输入框", "张三")
    断言_状态("用户名", "张三")
}

#测试
纯函数 测试_状态机() {
    渲染界面("loading.ycv")
    
    // 验证初始状态
    断言_状态机状态("页面状态", "加载中")
    断言_存在("加载指示器")
    
    // 触发状态转换
    触发事件("数据加载完成")
    
    // 验证状态变化
    断言_状态机状态("页面状态", "成功")
    断言_不存在("加载指示器")
    断言_存在("成功消息")
}
```

### 3.4 表单验证测试

```御程
#测试
纯函数 测试_表单验证_必填() {
    渲染界面("register.ycv")
    
    // 直接提交空表单
    点击("提交按钮")
    
    // 验证错误消息
    断言_验证错误("用户名输入框", "用户名不能为空")
    断言_验证错误("密码输入框", "密码不能为空")
    断言_表单无效("注册表单")
}

#测试
纯函数 测试_表单验证_格式() {
    渲染界面("register.ycv")
    
    // 输入无效邮箱
    输入文本("邮箱输入框", "invalid-email")
    失焦("邮箱输入框")
    
    断言_验证错误("邮箱输入框", "请输入有效的邮箱地址")
    
    // 输入有效邮箱
    清空输入("邮箱输入框")
    输入文本("邮箱输入框", "test@example.com")
    失焦("邮箱输入框")
    
    断言_无验证错误("邮箱输入框")
}

#测试
纯函数 测试_表单验证_密码匹配() {
    渲染界面("register.ycv")
    
    输入文本("密码输入框", "password123")
    输入文本("确认密码输入框", "password456")
    失焦("确认密码输入框")
    
    断言_验证错误("确认密码输入框", "两次密码不一致")
    
    // 修正密码
    清空输入("确认密码输入框")
    输入文本("确认密码输入框", "password123")
    
    断言_无验证错误("确认密码输入框")
    断言_表单有效("注册表单")
}
```

### 3.5 列表渲染测试

```御程
#测试
纯函数 测试_列表渲染() {
    渲染界面("userlist.ycv")
    
    // 设置数据
    设置状态(用户列表: [
        { 姓名: "张三", 年龄: 25 },
        { 姓名: "李四", 年龄: 30 },
        { 姓名: "王五", 年龄: 28 }
    ])
    
    // 验证列表项数量
    断言_子元素数量("用户列表", 3)
    
    // 验证列表内容
    断言_列表项文本("用户列表", 0, 包含: "张三")
    断言_列表项文本("用户列表", 1, 包含: "李四")
    断言_列表项文本("用户列表", 2, 包含: "王五")
}

#测试
纯函数 测试_列表增删() {
    渲染界面("todolist.ycv")
    
    // 添加项目
    输入文本("新任务输入框", "学习御程")
    点击("添加按钮")
    
    断言_子元素数量("任务列表", 1)
    断言_列表项文本("任务列表", 0, "学习御程")
    
    // 删除项目
    点击("删除按钮", 在: "任务列表[0]")
    断言_子元素数量("任务列表", 0)
}
```


### 3.6 动画测试

```御程
#测试
纯函数 测试_入场动画() {
    渲染界面("animated.ycv")
    
    // 验证动画定义
    断言_动画存在("淡入")
    断言_动画属性("淡入", 时长: 300, 缓动: "渐出")
    
    // 触发动画
    显示元素("动画卡片")
    
    // 验证动画状态
    断言_动画播放中("动画卡片", "淡入")
    
    // 等待动画完成
    等待动画完成("动画卡片")
    断言_动画已完成("动画卡片", "淡入")
}

#测试
纯函数 测试_循环动画() {
    渲染界面("loading.ycv")
    
    // 验证循环动画
    断言_动画循环("加载指示器", "旋转")
    
    // 暂停动画
    暂停动画("加载指示器")
    断言_动画已暂停("加载指示器")
    
    // 恢复动画
    恢复动画("加载指示器")
    断言_动画播放中("加载指示器", "旋转")
}
```

### 3.7 主题测试

```御程
#测试
纯函数 测试_主题应用() {
    渲染界面("themed.ycv")
    
    // 验证默认主题
    断言_当前主题("亮色主题")
    断言_样式("主按钮", 背景色: "#1976D2")
    断言_样式("页面背景", 背景色: "#ffffff")
    
    // 切换主题
    切换主题("暗色主题")
    
    // 验证主题变化
    断言_当前主题("暗色主题")
    断言_样式("页面背景", 背景色: "#1e1e1e")
    断言_样式("文本", 颜色: "#e0e0e0")
}

#测试
纯函数 测试_主题变量() {
    渲染界面("themed.ycv")
    
    // 验证主题变量
    断言_主题变量("主色", "#1976D2")
    断言_主题变量("圆角", "4px")
    
    // 修改主题变量
    设置主题变量("主色", "#4caf50")
    
    // 验证变量应用
    断言_样式("主按钮", 背景色: "#4caf50")
}
```

### 3.8 国际化测试

```御程
#测试
纯函数 测试_多语言切换() {
    渲染界面("i18n.ycv")
    
    // 验证默认语言
    断言_当前语言("中文")
    断言_文本("欢迎标签", "欢迎使用御程")
    断言_文本("登录按钮", "登录")
    
    // 切换语言
    切换语言("英文")
    
    // 验证语言变化
    断言_当前语言("英文")
    断言_文本("欢迎标签", "Welcome to YuCheng")
    断言_文本("登录按钮", "Login")
}

#测试
纯函数 测试_多语言参数() {
    渲染界面("i18n.ycv")
    
    设置状态(用户名: "张三")
    
    // 中文带参数
    断言_文本("欢迎用户标签", "欢迎，张三！")
    
    // 切换到英文
    切换语言("英文")
    断言_文本("欢迎用户标签", "Welcome, 张三!")
}
```

### 3.9 无障碍测试

```御程
#测试
纯函数 测试_无障碍标签() {
    渲染界面("accessible.ycv")
    
    // 验证无障碍标签
    断言_无障碍标签("首页按钮", "返回首页")
    断言_无障碍角色("导航区域", "导航")
    断言_无障碍描述("应用", "这是一个演示无障碍功能的应用")
}

#测试
纯函数 测试_键盘导航() {
    渲染界面("accessible.ycv")
    
    // 验证Tab顺序
    按键(Tab)
    断言_已聚焦("首页按钮")
    
    按键(Tab)
    断言_已聚焦("搜索框")
    
    按键(Tab)
    断言_已聚焦("用户菜单")
    
    // 验证快捷键
    按键组合(Alt, H)
    断言_已聚焦("首页按钮")
}

#测试
纯函数 测试_屏幕阅读器() {
    渲染界面("accessible.ycv")
    
    // 验证公告
    设置状态(状态消息: "登录成功")
    断言_公告内容("登录成功")
    
    // 验证表单错误公告
    点击("提交按钮")
    断言_公告包含("表单验证失败")
}

#测试
纯函数 测试_焦点陷阱() {
    渲染界面("modal.ycv")
    
    // 打开对话框
    点击("打开对话框按钮")
    
    // 验证焦点被限制
    断言_焦点在区域内("对话框")
    
    // Tab循环
    循环 10 次 {
        按键(Tab)
        断言_焦点在区域内("对话框")
    }
    
    // 关闭对话框
    按键(Escape)
    断言_焦点不在区域内("对话框")
}
```


### 3.10 视觉回归测试

```御程
#测试
纯函数 测试_视觉快照() {
    渲染界面("dashboard.ycv")
    
    // 截取快照并比较
    断言_快照匹配("dashboard-default")
    
    // 不同状态的快照
    设置状态(已登录: 真)
    断言_快照匹配("dashboard-logged-in")
    
    // 响应式快照
    设置视口(宽度: 375, 高度: 667)  // 手机
    断言_快照匹配("dashboard-mobile")
    
    设置视口(宽度: 768, 高度: 1024)  // 平板
    断言_快照匹配("dashboard-tablet")
}

#测试
纯函数 测试_样式一致性() {
    渲染界面("buttons.ycv")
    
    // 验证所有按钮样式一致
    变量 按钮列表 = 查询所有("按钮")
    
    循环 按钮 在 按钮列表 {
        断言_样式(按钮, 圆角: "4px")
        断言_样式(按钮, 字体大小: "14px")
    }
}
```

---

## 四、前后端集成测试

### 4.1 API 模拟测试

```御程
#测试
纯函数 测试_登录流程() {
    // 模拟API
    模拟接口("/api/login") {
        请求匹配 { 用户名: "testuser", 密码: "password123" }
        响应 { 成功: 真, 令牌: "mock-token", 用户: { 姓名: "测试用户" } }
    }
    
    渲染界面("login.ycv")
    
    // 执行登录
    输入文本("用户名输入框", "testuser")
    输入文本("密码输入框", "password123")
    点击("登录按钮")
    
    // 等待异步操作
    等待(接口调用完成: "/api/login")
    
    // 验证结果
    断言_接口已调用("/api/login", 次数: 1)
    断言_状态("已登录", 真)
    断言_状态("用户.姓名", "测试用户")
    断言_导航到("/dashboard")
}

#测试
纯函数 测试_登录失败() {
    模拟接口("/api/login") {
        响应 { 成功: 假, 错误: "用户名或密码错误" }
        状态码: 401
    }
    
    渲染界面("login.ycv")
    
    输入文本("用户名输入框", "wronguser")
    输入文本("密码输入框", "wrongpass")
    点击("登录按钮")
    
    等待(接口调用完成: "/api/login")
    
    // 验证错误处理
    断言_存在("错误消息")
    断言_文本("错误消息", "用户名或密码错误")
    断言_状态("已登录", 假)
}
```

### 4.2 数据加载测试

```御程
#测试
纯函数 测试_数据列表加载() {
    模拟接口("/api/users") {
        响应 {
            数据: [
                { 编号: 1, 姓名: "张三", 邮箱: "zhang@test.com" },
                { 编号: 2, 姓名: "李四", 邮箱: "li@test.com" }
            ],
            总数: 2
        }
    }
    
    渲染界面("userlist.ycv")
    
    // 等待数据加载
    等待(接口调用完成: "/api/users")
    
    // 验证列表渲染
    断言_子元素数量("用户列表", 2)
    断言_列表项文本("用户列表", 0, 包含: "张三")
    断言_列表项文本("用户列表", 1, 包含: "李四")
}

#测试
纯函数 测试_分页加载() {
    模拟接口("/api/users") {
        请求匹配 { 页码: 1, 每页: 10 }
        响应 { 数据: 生成用户(10), 总数: 25, 总页数: 3 }
    }
    
    模拟接口("/api/users") {
        请求匹配 { 页码: 2, 每页: 10 }
        响应 { 数据: 生成用户(10, 起始: 11), 总数: 25, 总页数: 3 }
    }
    
    渲染界面("userlist.ycv")
    
    // 验证第一页
    等待(接口调用完成: "/api/users")
    断言_子元素数量("用户列表", 10)
    断言_文本("分页信息", "第 1 页，共 3 页")
    
    // 翻到第二页
    点击("下一页按钮")
    等待(接口调用完成: "/api/users")
    
    断言_文本("分页信息", "第 2 页，共 3 页")
}
```

### 4.3 实时数据测试

```御程
#测试
纯函数 测试_WebSocket连接() {
    // 模拟WebSocket
    模拟WebSocket("/ws/notifications") 为 ws模拟
    
    渲染界面("notifications.ycv")
    
    // 验证连接
    断言_WebSocket已连接(ws模拟)
    
    // 模拟接收消息
    ws模拟.发送({
        类型: "新消息",
        内容: "您有一条新通知",
        时间: "2026-01-11 10:00:00"
    })
    
    // 验证UI更新
    等待(元素出现: "通知徽章")
    断言_文本("通知徽章", "1")
    断言_存在("通知列表项")
}

#测试
纯函数 测试_实时更新() {
    模拟WebSocket("/ws/data") 为 ws模拟
    
    渲染界面("realtime-chart.ycv")
    
    // 发送多个数据点
    循环 i 在 1..5 {
        ws模拟.发送({ 值: i * 10, 时间戳: 当前时间() })
        等待(100毫秒)
    }
    
    // 验证图表更新
    断言_图表数据点数量("实时图表", 5)
}
```


### 4.4 错误处理测试

```御程
#测试
纯函数 测试_网络错误处理() {
    模拟接口("/api/data") {
        网络错误: "连接超时"
    }
    
    渲染界面("data-view.ycv")
    
    等待(接口调用完成: "/api/data")
    
    // 验证错误UI
    断言_存在("错误提示")
    断言_文本("错误提示", 包含: "网络错误")
    断言_存在("重试按钮")
}

#测试
纯函数 测试_重试机制() {
    变量 调用次数 = 0
    
    模拟接口("/api/data") {
        动态响应 {
            调用次数 = 调用次数 + 1
            若 调用次数 < 3 {
                返回 { 状态码: 500, 错误: "服务器错误" }
            } 否则 {
                返回 { 状态码: 200, 数据: "成功" }
            }
        }
    }
    
    渲染界面("data-view.ycv")
    
    // 等待自动重试
    等待(条件: 调用次数 >= 3, 超时: 5秒)
    
    // 验证最终成功
    断言_不存在("错误提示")
    断言_存在("数据内容")
}
```

### 4.5 性能测试

```御程
#性能测试
纯函数 测试_大列表渲染性能() {
    // 生成大量数据
    变量 大数据 = 生成用户(1000)
    
    设置状态(用户列表: 大数据)
    
    // 测量渲染时间
    变量 渲染时间 = 测量时间 {
        渲染界面("userlist.ycv")
    }
    
    // 性能断言
    断言_小于(渲染时间, 1000毫秒, "大列表渲染应在1秒内完成")
    
    // 测量滚动性能
    变量 帧率 = 测量帧率 {
        滚动到底部("用户列表")
    }
    
    断言_大于(帧率, 30, "滚动帧率应大于30fps")
}

#性能测试
纯函数 测试_频繁更新性能() {
    渲染界面("counter.ycv")
    
    变量 更新时间列表 = []
    
    循环 100 次 {
        变量 时间 = 测量时间 {
            点击("增加按钮")
            等待(UI更新完成)
        }
        追加(更新时间列表, 时间)
    }
    
    // 验证平均更新时间
    变量 平均时间 = 平均值(更新时间列表)
    断言_小于(平均时间, 16毫秒, "单次更新应在16ms内完成")
}
```

---

## 五、测试工具函数参考

### 5.1 渲染与查询

| 函数 | 说明 | 示例 |
|------|------|------|
| `渲染界面(文件)` | 渲染.ycv文件 | `渲染界面("login.ycv")` |
| `查询(选择器)` | 查询单个元素 | `查询("登录按钮")` |
| `查询所有(选择器)` | 查询所有匹配元素 | `查询所有("列表项")` |
| `等待(条件)` | 等待条件满足 | `等待(元素出现: "成功消息")` |

### 5.2 交互模拟

| 函数 | 说明 | 示例 |
|------|------|------|
| `点击(元素)` | 模拟点击 | `点击("提交按钮")` |
| `双击(元素)` | 模拟双击 | `双击("列表项")` |
| `右键点击(元素)` | 模拟右键 | `右键点击("文件项")` |
| `输入文本(元素, 文本)` | 输入文本 | `输入文本("输入框", "hello")` |
| `清空输入(元素)` | 清空输入框 | `清空输入("搜索框")` |
| `聚焦(元素)` | 聚焦元素 | `聚焦("输入框")` |
| `失焦(元素)` | 移除焦点 | `失焦("输入框")` |
| `按键(键)` | 模拟按键 | `按键(回车)` |
| `按键组合(键...)` | 组合键 | `按键组合(Ctrl, S)` |
| `拖拽(源, 目标)` | 拖拽操作 | `拖拽("项目1", "文件夹")` |
| `滚动到(元素)` | 滚动到元素 | `滚动到("底部")` |
| `悬停(元素)` | 鼠标悬停 | `悬停("菜单项")` |

### 5.3 断言函数

| 函数 | 说明 | 示例 |
|------|------|------|
| `断言_存在(元素)` | 元素存在（基于 UI 契约注册的元素 ID） | `断言_存在("按钮")` |
| `断言_不存在(元素)` | 元素不存在 | `断言_不存在("错误")` |
| `断言_可见(元素)` | 元素可见（当前实现为宽松校验，主要用于语义表达） | `断言_可见("对话框")` |
| `断言_隐藏(元素)` | 元素隐藏（当前实现为宽松校验） | `断言_隐藏("加载中")` |
| `断言_文本(元素, 文本)` | 文本内容，通过内部状态键 `text_{元素}` 校验 | `断言_文本("标题", "欢迎")` |
| `断言_输入值(元素, 值)` | 输入框值，通过状态键 `input_{元素}` 校验 | `断言_输入值("输入框", "test")` |
| `断言_已选中(元素)` | 复选框选中，约定属性 `checked="true"` | `断言_已选中("同意条款")` |
| `断言_已禁用(元素)` | 元素禁用（当前实现为宽松校验） | `断言_已禁用("提交按钮")` |
| `断言_已聚焦(元素)` | 元素聚焦（预留） | `断言_已聚焦("输入框")` |
| `断言_样式(元素, 属性, 值)` | 样式属性（预留，依赖运行时样式采集） | `断言_样式("按钮", 背景色: "red")` |
| `断言_状态(键, 值)` | 逻辑状态值（直接使用链路测试状态存储） | `断言_状态("计数", 10)` |
| `断言_子元素数量(容器, 数量)` | 子元素数量，使用选择器 ID + 期望数量 | `断言_子元素数量("用户列表", 3)` |
| `断言_列表项文本(列表, 索引, 文本)` | 列表项文本，内部元素 ID 约定为 `列表ID[索引]` | `断言_列表项文本("用户列表", 0, "张三")` |
| `断言_导航到(路径)` | 校验最终导航路径（基于链路测试 current_url） | `断言_导航到("/dashboard")` |
| `断言_快照匹配(名称)` | 视觉快照（规划中，会接入截图比对） | `断言_快照匹配("首页")` |

### 5.4 API模拟

| 函数 | 说明 | 示例 |
|------|------|------|
| `模拟接口(路径)` | 模拟HTTP接口 | `模拟接口("/api/login")` |
| `模拟WebSocket(路径)` | 模拟WebSocket | `模拟WebSocket("/ws")` |
| `断言_接口已调用(路径)` | 验证接口调用 | `断言_接口已调用("/api/data")` |
| `获取接口调用(路径)` | 获取调用详情 | `获取接口调用("/api/login")` |

---

## 六、完整测试示例

```御程
// 文件: tests/login-test.ycs

导入 测试框架

#测试套件 "登录功能测试"
{
    #前置
    纯函数 准备() {
        // 重置状态
        重置所有模拟()
        清除本地存储()
    }
    
    #后置
    纯函数 清理() {
        卸载界面()
    }
    
    #测试 "成功登录"
    纯函数 测试_成功登录() {
        模拟接口("/api/login") {
            响应 { 成功: 真, 令牌: "token123" }
        }
        
        渲染界面("login.ycv")
        
        输入文本("用户名", "admin")
        输入文本("密码", "password")
        点击("登录按钮")
        
        等待(导航发生)
        
        断言_导航到("/dashboard")
        断言_本地存储("token", "token123")
    }
    
    #测试 "空用户名验证"
    纯函数 测试_空用户名() {
        渲染界面("login.ycv")
        
        点击("登录按钮")
        
        断言_验证错误("用户名", "用户名不能为空")
        断言_接口未调用("/api/login")
    }
    
    #测试 "记住我功能"
    纯函数 测试_记住我() {
        模拟接口("/api/login") {
            响应 { 成功: 真, 令牌: "token123" }
        }
        
        渲染界面("login.ycv")
        
        输入文本("用户名", "admin")
        输入文本("密码", "password")
        点击("记住我复选框")
        点击("登录按钮")
        
        等待(接口调用完成: "/api/login")
        
        断言_本地存储存在("remember_token")
    }
    
    #测试 "登录按钮加载状态"
    纯函数 测试_加载状态() {
        模拟接口("/api/login") {
            延迟: 1000毫秒
            响应 { 成功: 真 }
        }
        
        渲染界面("login.ycv")
        
        输入文本("用户名", "admin")
        输入文本("密码", "password")
        点击("登录按钮")
        
        // 验证加载状态
        断言_已禁用("登录按钮")
        断言_文本("登录按钮", "登录中...")
        断言_存在("加载指示器")
        
        等待(接口调用完成: "/api/login")
        
        // 验证恢复状态
        断言_未禁用("登录按钮")
        断言_文本("登录按钮", "登录")
    }
}
```

---

## 七、运行测试

```bash
# 运行所有UI测试
yucheng test --ui

# 运行特定测试文件
yucheng test tests/login-test.ycs

# 运行带覆盖率
yucheng test --ui --coverage

# 生成测试报告
yucheng test --ui --report html

# 更新快照
yucheng test --ui --update-snapshots

# 交互模式（可视化测试）
yucheng test --ui --interactive
```
