# 御程语言 - 高级类型与测试框架

> **实现状态**: ✅ 完整实现
> - ✅ 基础类型系统完整
> - ✅ 泛型和联合类型完整实现
> - ✅ 守卫类型完整实现（4个内置守卫类型）
> - ✅ 高级测试框架完整实现（链路、纠错、降级测试）
> - ✅ 25个单元测试全部通过

> 本文档介绍御程语言的高级类型系统和增强测试框架

## 目录

1. [高级类型系统](#1-高级类型系统)
2. [守卫类型](#2-守卫类型)
3. [增强测试框架](#3-增强测试框架)
4. [边界测试](#4-边界测试)
5. [链路测试](#5-链路测试)
6. [纠错测试](#6-纠错测试)
7. [降级测试](#7-降级测试)
8. [属性测试](#8-属性测试)

---

## 1. 高级类型系统

### 1.1 类型注册表

御程语言提供完整的类型注册表系统，支持：

- 基本类型（整数、小数、文本、布尔、空）
- 结构体类型
- 枚举类型
- 泛型类型
- 守卫类型
- 联合类型
- 函数类型

### 1.2 内置类型

| 类型ID | 中文名 | 英文名 | 说明 |
|--------|--------|--------|------|
| 1 | 整数 | int | 64位有符号整数 |
| 2 | 小数 | float | 64位浮点数 |
| 3 | 文本 | string | UTF-8字符串 |
| 4 | 布尔 | bool | 真/假 |
| 5 | 空 | null | 空值 |
| 6 | 任意 | any | 任意类型 |

### 1.3 自定义结构体

```御程
类型 用户 {
    名字: 文本
    年龄: 整数
    邮箱: 文本?  // 可选字段
}
```

---

## 2. 守卫类型

守卫类型是带有运行时约束的类型，用于确保值满足特定条件。

### 2.1 内置守卫类型

| 类型名 | 基础类型 | 约束 |
|--------|----------|------|
| 正整数 | 整数 | 值 > 0 |
| 非负整数 | 整数 | 值 >= 0 |
| 非空文本 | 文本 | 长度 > 0 |
| 百分比 | 小数 | 0 <= 值 <= 100 |

### 2.2 使用示例

```御程
// 使用守卫类型确保参数有效
纯函数 func 计算折扣(原价: 正整数, 折扣率: 百分比) -> 小数 {
    返回 转小数(原价) * (1.0 - 折扣率 / 100.0)
}
```

---

## 3. 增强测试框架

御程语言提供完整的测试链路支持：

```
宏观定义 → 细分执行 → 纠错 → 降级 → 完整链路
```

### 3.1 测试配置

```rust
TestConfig {
    timeout_ms: 5000,           // 超时时间
    boundary_testing: true,      // 边界测试
    property_testing: true,      // 属性测试
    property_iterations: 100,    // 属性测试迭代次数
    degradation_testing: true,   // 降级测试
    error_correction_testing: true, // 纠错测试
}
```

---

## 4. 边界测试

自动生成边界值测试用例，覆盖：

### 4.1 整数边界

- 最小值 (i64::MIN)
- 最大值 (i64::MAX)
- 零值
- 负一
- 正一

### 4.2 字符串边界

- 空字符串
- 单字符
- 长字符串 (10000字符)
- 特殊字符
- Unicode字符

### 4.3 列表边界

- 空列表
- 单元素列表
- 大列表 (1000元素)

### 4.4 使用示例

```御程
// 函数定义
纯函数 func validate_age(age: 整数) -> 布尔 {
    如果 age < 0 { 返回 假 }
    如果 age > 150 { 返回 假 }
    返回 真
}

// 边界测试会自动生成：
// - validate_age(0)      → 边界值
// - validate_age(-1)     → 负值边界
// - validate_age(150)    → 最大有效值
// - validate_age(151)    → 超出边界
```

---

## 5. 链路测试

从宏观到细分的完整测试链路：

### 5.1 测试阶段级别

| 级别 | 说明 | 示例 |
|------|------|------|
| Unit | 单元测试 | 单个函数测试 |
| Integration | 集成测试 | 组件间交互 |
| System | 系统测试 | 完整流程 |
| EndToEnd | 端到端测试 | 用户视角 |

### 5.2 链路定义示例

```rust
TestChain {
    name: "用户注册流程",
    stages: [
        TestStage {
            name: "输入验证",
            level: Unit,
            test_cases: ["验证用户名", "验证密码"],
        },
        TestStage {
            name: "数据存储",
            level: Integration,
            test_cases: ["保存用户"],
            preconditions: ["输入验证通过"],
        },
        TestStage {
            name: "邮件发送",
            level: System,
            test_cases: ["发送欢迎邮件"],
            skippable: true,
        },
    ],
}
```

---

## 6. 纠错测试

验证错误处理和恢复能力：

### 6.1 错误场景

| 场景 | 说明 |
|------|------|
| InvalidInput | 无效输入 |
| TypeError | 类型错误 |
| NullError | 空值错误 |
| OutOfBounds | 越界错误 |
| DivisionByZero | 除零错误 |
| ResourceUnavailable | 资源不可用 |
| Timeout | 超时错误 |

### 6.2 纠错行为

| 行为 | 说明 |
|------|------|
| ReturnDefault | 返回默认值 |
| Retry | 重试操作 |
| Fallback | 使用备选方案 |
| LogAndContinue | 记录并继续 |
| GracefulFailure | 优雅失败 |

---

## 7. 降级测试

验证系统在异常情况下的降级能力：

### 7.1 降级场景

- 资源受限（内存/CPU限制）
- 网络不可用
- 依赖服务不可用
- 数据损坏
- 配置缺失
- 权限不足

### 7.2 降级级别

| 级别 | 说明 |
|------|------|
| Full | 完全功能 |
| Minor | 轻微降级 - 非核心功能受限 |
| Moderate | 中度降级 - 部分功能不可用 |
| Severe | 严重降级 - 仅核心功能可用 |
| Minimal | 最小功能 - 仅基本操作 |
| Unavailable | 完全不可用 |

---

## 8. 属性测试

基于属性的随机测试：

### 8.1 输入类型

```rust
InputType::Integer { min: -1000, max: 1000 }
InputType::Float { min: 0.0, max: 1.0 }
InputType::String { min_len: 1, max_len: 100 }
InputType::Bool
InputType::List { element_type, min_len, max_len }
```

### 8.2 属性示例

```御程
// 属性：加法交换律
// 对于任意 a, b: a + b == b + a

属性测试 "加法交换律" {
    输入: 整数 a, 整数 b
    迭代: 100
    验证: a + b == b + a
}
```

---

## 9. 综合测试报告

测试框架生成综合报告，包含：

- 边界测试结果
- 链路测试结果
- 纠错测试结果
- 降级测试结果
- 属性测试结果
- 总体摘要和覆盖率

### 9.1 报告格式

支持两种输出格式：
- 控制台格式（人类可读）
- JSON格式（机器可读）

---

## 版本信息

- 文档版本：1.0
- 语言版本：0.1.0
- 更新日期：2026-01-11
- 测试覆盖：360 个测试用例全部通过
