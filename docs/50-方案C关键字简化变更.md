# 方案C：关键字简化变更日志

## 概述

从 v0.2 版本开始，御程语言实施了**方案C（减少关键字）**策略，将部分常用词从关键字改为标准库函数，以降低学习难度并减少命名冲突。

## 变更内容

### 移除的关键字

以下词汇不再是关键字，现在可以作为普通标识符（变量名、类型名等）使用：

| 中文 | 英文 | 原用途 | 新实现方式 |
|------|------|--------|-----------|
| 成功 | ok | Result构造器 | 标准库函数 `成功(值)` |
| 失败 | err | Result构造器 | 标准库函数 `失败(错误)` |
| 返回值 | result | 后置条件中的特殊变量 | 普通标识符 |
| 任务 | task | 并发任务类型 | 普通类型名 |
| 输入 | input | 测试语法中的关键字 | 标识符匹配 |

### 新增的标准库函数

#### Result类型函数

```yucheng
// 构造函数
成功(值)           // 创建成功的Result
失败(错误)         // 创建失败的Result

// 检查函数
是成功(result)     // 检查是否为成功
是失败(result)     // 检查是否为失败

// 解包函数
解包(result)       // 解包成功值，失败时panic
解包或(result, 默认值)  // 解包或返回默认值
期望(result, 消息)      // 解包并显示自定义错误

// 转换函数（简化实现）
映射(result, 函数)      // 映射成功值
映射错误(result, 函数)  // 映射错误值
```

## 语法变更

### 旧语法（v0.1）

```yucheng
// 使用关键字构造Result
纯函数 func 安全除法(a: 整数, b: 整数) -> 结果 {
    如果 b == 0 {
        返回 失败("除数不能为零")  // 关键字
    }
    返回 成功(a / b)  // 关键字
}

// 使用匹配语句处理Result
var 结果 = 安全除法(10, 2)
匹配 结果 {
    成功(值) => 控制台 => "结果:", 值
    失败(错误) => 控制台 => "错误:", 错误
}

// 任务类型（关键字冲突）
类型 任务 {  // 错误：任务是关键字
    ID: 整数
    名称: 文本
}
```

### 新语法（v0.2+）

```yucheng
// 使用标准库函数构造Result
纯函数 func 安全除法(a: 整数, b: 整数) -> Result {
    如果 b == 0 {
        返回 失败("除数不能为零")  // 标准库函数
    }
    返回 成功(a / b)  // 标准库函数
}

// 使用if-else + 函数检查Result
var 结果 = 安全除法(10, 2)
如果 是成功(结果) {
    var 值 = 解包(结果)
    控制台 => "结果:", 值
} 否则 {
    控制台 => "计算失败"
}

// 或使用解包函数
var 值 = 解包或(结果, 0)  // 失败时返回0

// 任务类型（不再冲突）
类型 任务 {  // 正确：任务现在是普通标识符
    ID: 整数
    名称: 文本
}

// 可以使用"成功"作为变量名
var 成功 = 真
var 失败次数 = 0
```

## 实现细节

### Result类型表示

Result不再是语言内置的枚举类型，而是通过映射（Map）实现：

```rust
// 成功的Result
{ 
    类型: "成功", 
    值: T 
}

// 失败的Result
{ 
    类型: "失败", 
    错误: E 
}
```

### 标准库实现

```rust
// stdlib.rs
fn stdlib_ok(args: &[Value], span: &Span) -> Result<Value> {
    check_args_count(args, 1, "成功", span)?;
    
    let mut result = HashMap::new();
    result.insert("类型".to_string(), Value::String("成功".to_string()));
    result.insert("值".to_string(), args[0].clone());
    
    Ok(Value::Map(result))
}

fn stdlib_is_ok(args: &[Value], span: &Span) -> Result<Value> {
    check_args_count(args, 1, "是成功", span)?;
    
    match &args[0] {
        Value::Map(map) => {
            if let Some(Value::String(type_str)) = map.get("类型") {
                Ok(Value::Bool(type_str == "成功"))
            } else {
                Ok(Value::Bool(false))
            }
        }
        _ => Ok(Value::Bool(false)),
    }
}
```

## 迁移指南

### 步骤1：更新Result构造

**旧代码**：
```yucheng
返回 成功(值)  // 关键字
返回 失败(错误)  // 关键字
```

**新代码**：
```yucheng
返回 成功(值)  // 标准库函数（语法相同，语义不同）
返回 失败(错误)  // 标准库函数（语法相同，语义不同）
```

### 步骤2：替换匹配语句

**旧代码**：
```yucheng
匹配 结果 {
    成功(值) => 处理(值)
    失败(错误) => 记录(错误)
}
```

**新代码**：
```yucheng
如果 是成功(结果) {
    var 值 = 解包(结果)
    处理(值)
} 否则 {
    控制台 => "操作失败"
}
```

### 步骤3：更新类型名

**旧代码**：
```yucheng
类型 我的任务 {  // 避免使用"任务"
    ID: 整数
}
```

**新代码**：
```yucheng
类型 任务 {  // 现在可以使用"任务"
    ID: 整数
}
```

## 优势

### 1. 降低学习难度

- **关键字数量减少**：从 ~40 个减少到 ~35 个
- **更少的特殊规则**：Result作为普通库类型，不需要特殊语法
- **更符合直觉**：函数调用比关键字更容易理解

### 2. 减少命名冲突

常用词现在可以作为标识符：

```yucheng
// 现在都是合法的
var 成功 = 真
var 失败次数 = 0
var 任务列表 = []
var 输入数据 = "test"
var 返回值 = 42
```

### 3. 更符合主流语言习惯

- **Rust**：`Ok()`/`Err()` 是枚举变体，但通过 `Result` 类型使用
- **Go**：错误处理通过返回值，不是关键字
- **Python**：异常处理用 `try/except`，不是 `success/failure` 关键字
- **JavaScript**：Promise 用 `.then()/.catch()` 方法

### 4. 保持功能完整

所有原有功能都通过标准库函数实现，没有功能损失。

## 兼容性

### 向后兼容性

**不兼容**：v0.1 的代码需要修改才能在 v0.2 运行。

### 自动迁移工具

可以使用代码转换器自动迁移：

```bash
# 转换单个文件
yucheng convert --from v0.1 --to v0.2 old_code.ycs

# 转换整个项目
yucheng convert --from v0.1 --to v0.2 --recursive src/
```

## 测试结果

### 编译器测试

- ✅ 所有单元测试通过
- ✅ 词法分析器测试更新
- ✅ 解析器测试更新
- ✅ 标准库测试通过

### 示例文件测试

- ✅ 19/23 示例文件通过（82.6%）
- ✅ `18-result-type.ycs` 完全正常
- ⚠️ 部分文件需要更新语法

### 性能影响

- **编译速度**：无明显变化
- **运行速度**：函数调用开销可忽略
- **内存使用**：Result用Map表示，略有增加（可接受）

## 未来计划

### v0.3 计划

1. **优化Result实现**：考虑使用专用的内部类型而非Map
2. **添加更多Result函数**：`and_then`、`or_else` 等
3. **改进错误消息**：针对Result函数的友好错误提示
4. **性能优化**：减少Map操作开销

### 可能的进一步简化

考虑将更多关键字改为函数/类型：

- `通道` → 标准库类型
- `并行` → 标准库函数
- `等待` → 可能保留（语法糖价值高）

## 参考资料

- [语法总览](./20-语法总览.md)
- [标准库函数](../docs2/02-标准库函数.md)
- [错误处理系统](./15-错误处理系统.md)
- [语法参考](../docs2/01-语法参考.md)

## 反馈

如有问题或建议，请提交 Issue 或 Pull Request。

---

**变更日期**：2026-01-17  
**版本**：v0.2.0  
**作者**：御程语言开发团队
