# 御程语言语法参考

## 关键字系统

御程支持中英文双语关键字，编译器内部统一处理。

### 关键字映射表

```rust
// keywords.rs 中的定义
pub static KEYWORDS: &[(&str, &str, TokenKind)] = &[
    // 函数分类
    ("纯函数", "pure", TokenKind::Pure),
    ("查询", "query", TokenKind::Query),
    ("副作用", "effect", TokenKind::Effect),
    
    // 声明
    ("func", "func", TokenKind::Func),
    ("var", "var", TokenKind::Var),
    ("let", "let", TokenKind::Let),
    ("结构", "struct", TokenKind::Struct),
    ("枚举", "enum", TokenKind::Enum),
    ("类型", "type", TokenKind::Type),
    
    // 控制流
    ("如果", "if", TokenKind::If),
    ("否则", "else", TokenKind::Else),
    ("否则如果", "elif", TokenKind::ElseIf),
    ("循环", "for", TokenKind::For),
    ("当", "while", TokenKind::While),
    ("匹配", "match", TokenKind::Match),
    ("返回", "return", TokenKind::Return),
    ("中断", "break", TokenKind::Break),
    ("继续", "continue", TokenKind::Continue),
    
    // 契约
    ("要求", "requires", TokenKind::Requires),
    ("保证", "ensures", TokenKind::Ensures),
    ("断言", "assert", TokenKind::Assert),
    
    // 异常
    ("尝试", "try", TokenKind::Try),
    ("捕获", "catch", TokenKind::Catch),
    ("最终", "finally", TokenKind::Finally),
    ("抛出", "throw", TokenKind::Throw),
    
    // 内存
    ("不安全", "unsafe", TokenKind::Unsafe),
    ("延迟", "defer", TokenKind::Defer),
    
    // 布尔值
    ("真", "true", TokenKind::True),
    ("假", "false", TokenKind::False),
    ("空", "null", TokenKind::Null),
    
    // 逻辑运算
    ("且", "and", TokenKind::And),
    ("或", "or", TokenKind::Or),
    ("非", "not", TokenKind::Not),
    
    // 范围
    ("在", "in", TokenKind::In),
];
```

## 类型系统

### 基本类型

| 类型 | 中文 | 说明 | 示例 |
|------|------|------|------|
| `整数` | Int | 64位有符号整数 | `42`, `-100` |
| `小数` | Float | 64位浮点数 | `3.14`, `-0.5` |
| `布尔` | Bool | 布尔值 | `真`, `假` |
| `文本` | String | UTF-8 字符串 | `"你好"` |
| `空` | Null | 空值 | `空` |

### 复合类型

```yucheng
// 列表
var 数字列表: 列表<整数> = [1, 2, 3]

// 字典
var 映射: 字典<文本, 整数> = {"一": 1, "二": 2}

// 可选类型
var 可能为空: 整数? = 空

// Result类型（通过标准库函数）
var 结果 = 成功(42)  // 成功是标准库函数
```

### 类型定义

```yucheng
// 结构体
结构 用户 {
    名字: 文本,
    年龄: 整数,
    邮箱: 文本?,
}

// 枚举
枚举 状态 {
    待处理,
    处理中,
    已完成,
    失败(文本),
}

// 类型别名
类型 用户ID = 整数
```

## 函数定义

### 函数三分类

御程强制要求每个函数声明其分类：

```yucheng
// 纯函数：无副作用，相同输入总是返回相同输出
纯函数 func 加法(a: 整数, b: 整数) -> 整数 {
    返回 a + b
}

// 查询：可读取外部状态，但不可修改
查询 func 获取用户(id: 整数) -> 用户? {
    返回 数据库.查询(id)
}

// 副作用：可进行任何操作
副作用 func 保存用户(用户: 用户) {
    数据库.保存(用户)
    打印("用户已保存")
}
```

### 契约式设计

```yucheng
纯函数 func 除法(被除数: 整数, 除数: 整数) -> 整数
    要求 除数 != 0        // 前置条件
    保证 结果 * 除数 == 被除数  // 后置条件
{
    返回 被除数 / 除数
}
```

### 异步函数

```yucheng
异步 查询 func 获取数据(url: 文本) -> 结果<文本, 错误> {
    var 响应 = 等待 HTTP获取(url)
    返回 响应.内容
}
```

## 控制流

### 条件语句

```yucheng
如果 条件 {
    // 分支1
} 否则如果 其他条件 {
    // 分支2
} 否则 {
    // 默认分支
}
```

### 循环语句

```yucheng
// for 循环
循环 i 在 0..10 {
    打印(i)
}

// 遍历列表
循环 项 在 列表 {
    打印(项)
}

// while 循环
当 条件 {
    // 循环体
}
```

### 模式匹配

```yucheng
匹配 值 {
    1 => 打印("一"),
    2 | 3 => 打印("二或三"),
    n 如果 n > 10 => 打印("大于十"),
    _ => 打印("其他"),
}

// 使用if-else检查Result
如果 是成功(结果) {
    var 值 = 解包(结果)
    打印(值)
} 否则 {
    打印("操作失败")
}
```

## 表达式

### 运算符

```yucheng
// 算术运算
a + b    // 加法
a - b    // 减法
a * b    // 乘法
a / b    // 除法
a % b    // 取模

// 比较运算
a == b   // 等于
a != b   // 不等于
a < b    // 小于
a > b    // 大于
a <= b   // 小于等于
a >= b   // 大于等于

// 逻辑运算
a 且 b   // 逻辑与
a 或 b   // 逻辑或
非 a     // 逻辑非

// 管道运算
数据 |> 过滤(条件) |> 映射(转换) |> 归约(累加)
```

### Lambda 表达式

```yucheng
// 单参数
var 平方 = x => x * x

// 多参数
var 加法 = (a, b) => a + b

// 带类型注解
var 格式化 = (n: 整数) -> 文本 => 转文本(n)
```

### 条件表达式

```yucheng
var 结果 = 如果 条件 则 值1 否则 值2
```

## 错误处理

### Try-Catch

```yucheng
尝试 {
    var 结果 = 危险操作()
} 捕获 错误 {
    打印("发生错误:", 错误)
} 最终 {
    清理资源()
}
```

### Result类型（标准库函数）

**重要**：从v0.2开始，`成功`和`失败`是标准库函数，不再是关键字。

```yucheng
查询 func 读取文件(路径: 文本) -> Result {
    如果 !文件存在(路径) {
        返回 失败("文件不存在")  // 标准库函数
    }
    返回 成功(文件内容)  // 标准库函数
}

// 使用if-else检查
var 结果 = 读取文件("data.txt")
如果 是成功(结果) {
    var 内容 = 解包(结果)
    处理(内容)
} 否则 {
    打印("读取失败")
}

// 或使用解包函数
var 内容 = 解包或(结果, "默认内容")
```

## 模块系统

### 单文件模式 (.ycs)

```yucheng
// main.ycs
#规格

纯函数 func 计算(x: 整数) -> 整数

#实现

纯函数 func 计算(x: 整数) -> 整数 {
    返回 x * 2
}
```

### 多文件模式 (.yc + .yci)

```yucheng
// math.yc (规格文件)
纯函数 func 加法(a: 整数, b: 整数) -> 整数
    要求 a >= 0 且 b >= 0
    保证 结果 >= a 且 结果 >= b

// math.yci (实现文件)
纯函数 func 加法(a: 整数, b: 整数) -> 整数 {
    返回 a + b
}
```

### 链接文件 (.ycl)

```json
{
  "项目名称": "我的项目",
  "模块链接": [
    {
      "规格": "math.yc",
      "实现": "math.yci"
    },
    {
      "规格": "ui.yc",
      "实现": "ui.yci",
      "视图": "ui.ycv"
    }
  ]
}
```

## 内存管理

### 自动管理（默认）

```yucheng
副作用 func 示例() {
    var 数据 = [1, 2, 3]  // 自动分配
    // 离开作用域自动释放
}
```

### 手动管理

```yucheng
不安全 {
    var 指针 = 分配(1024)  // 手动分配
    // 使用内存
    释放(指针)              // 手动释放
}
```

### 延迟释放

```yucheng
副作用 func 使用资源() {
    var 文件 = 打开文件("data.txt")
    延迟 关闭(文件)  // 函数返回时自动执行
    
    // 使用文件...
}
```

## 注释

```yucheng
// 单行注释

/* 
   多行注释
   可以跨越多行
*/

/// 文档注释
/// 用于生成 API 文档
纯函数 func 示例() { }
```
