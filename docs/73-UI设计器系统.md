# UI设计器系统

> **实现状态**: 🚧 MVP开发中  
> **版本**: v1.0-alpha

## 一、系统概述

UI设计器是御程语言的创新功能，实现"所见即所信"的契约化UI开发。通过可视化设计 + 契约约束 + AI协作，让界面开发可定义、可验证、可协作、可教学。

### 1.1 核心特性

- **可视化画布**: 拖拽式UI设计，直观的元素编辑
- **契约驱动**: UI元素基于契约定义，保证行为一致性
- **四文件生成**: 自动生成 .yc/.yci/.ycv/.yct 完整文件
- **AI协作**: 智能样式优化、布局建议
- **实时预览**: 即时查看设计效果
- **历史记录**: 撤销/重做支持

### 1.2 与架构设计的集成

UI设计器与可视化架构设计系统深度集成：
- 架构图中的UI节点可直接打开UI设计器
- UI组件自动关联到架构图
- 契约双向同步

## 二、数据模型

### 2.1 UI元素 (UIElement)

```rust
pub struct UIElement {
    pub id: String,              // 唯一标识
    pub kind: ElementKind,       // 元素类型
    pub name: String,            // 元素名称
    pub properties: HashMap<String, PropertyValue>,  // 属性
    pub constraints: Vec<ContractClause>,  // 契约约束
    pub layout: LayoutInfo,      // 布局信息
    pub states: Vec<String>,     // 状态列表
    pub current_state: String,   // 当前状态
    pub locked: bool,            // 是否锁定
    pub children: Vec<String>,   // 子元素
}
```

### 2.2 元素类型

- **Button**: 按钮
- **TextInput**: 文本输入框
- **Label**: 标签
- **Container**: 容器
- **Checkbox**: 复选框
- **Radio**: 单选框
- **Select**: 下拉选择框
- **Textarea**: 多行文本框
- **Link**: 链接

### 2.3 UI画布 (UICanvas)

```rust
pub struct UICanvas {
    pub id: String,
    pub name: String,
    pub elements: HashMap<String, UIElement>,
    pub root_elements: Vec<String>,
    pub design_system: Option<DesignSystem>,
    pub metadata: CanvasMetadata,
}
```

## 三、使用指南

### 3.1 创建UI设计

1. 打开IDE，点击"UI设计"标签
2. 从左侧组件库拖拽元素到画布
3. 选中元素，在右侧编辑属性
4. 调整位置和大小
5. 点击"生成四文件"

### 3.2 编辑元素属性

选中元素后，可以编辑：
- **基本属性**: 名称、类型
- **布局属性**: 位置(x, y)、尺寸(width, height)
- **样式属性**: 背景色、文字颜色
- **锁定状态**: 防止误操作

### 3.3 生成四文件

点击"生成四文件"按钮，系统自动生成：

**契约文件 (.yc)**:
```yucheng
元素 登录按钮 {
    类型 = Button;
    状态 {
        default,
        hover,
        disabled,
    }
    保证 {
        必须可点击;
        禁用时透明度=0.5;
    }
}
```

**实现文件 (.yci)**:
```yucheng
实现 登录按钮 {
    backgroundColor = "#4CAF50";
    color = "#ffffff";
    位置 = { x: 100, y: 100 };
    尺寸 = { width: 120, height: 40 };
}
```

**验证文件 (.ycv)**:
```yucheng
验证 登录按钮 {
    保证 可点击 == 真;
    保证 禁用时 -> 透明度 == 0.5;
}
```

**测试文件 (.yct)**:
```yucheng
测试 "登录按钮应该可见" {
    断言 登录按钮.可见 == 真;
}
```

### 3.4 AI优化

选中元素后，点击"✨ AI优化样式"按钮：
- AI会分析当前设计
- 提供优化建议
- 自动应用改进（需确认）

## 四、快捷键

| 快捷键 | 功能 |
|--------|------|
| Ctrl+Z | 撤销 |
| Ctrl+Y | 重做 |
| Ctrl+S | 保存 |
| Ctrl+G | 生成四文件 |
| Delete | 删除选中元素 |
| Ctrl+D | 复制元素 |

## 五、API参考

### 5.1 Tauri命令

#### generate_ui_four_files
生成四文件

```typescript
await invoke('generate_ui_four_files', {
  canvasJson: JSON.stringify(canvas)
});
```

#### validate_ui_canvas
验证画布

```typescript
const errors = await invoke('validate_ui_canvas', {
  canvasJson: JSON.stringify(canvas)
});
```

#### save_ui_canvas
保存画布

```typescript
await invoke('save_ui_canvas', {
  canvasJson: JSON.stringify(canvas),
  path: 'my-ui.json'
});
```

#### load_ui_canvas
加载画布

```typescript
const canvasJson = await invoke('load_ui_canvas', {
  path: 'my-ui.json'
});
```

## 六、开发路线图

### Phase 1 (当前) - MVP
- [x] 基础画布
- [x] 基本元素（按钮、输入框、标签等）
- [x] 属性编辑
- [x] 四文件生成
- [x] 历史记录（撤销/重做）
- [ ] 元素拖拽
- [ ] 元素调整大小

### Phase 2 (计划中)
- [ ] 响应式系统集成
- [ ] 组件库扩展
- [ ] AI样式优化
- [ ] 设计系统集成
- [ ] 与架构图集成

### Phase 3 (未来)
- [ ] 跨平台预览
- [ ] 性能分析
- [ ] 教学模式
- [ ] 协作功能
- [ ] 导出功能

## 七、最佳实践

### 7.1 命名规范

- 使用清晰的业务名称
- 避免技术实现细节
- 保持一致的命名风格

```
✅ 好的命名:
- 登录按钮
- 用户名输入框
- 提交表单

❌ 不好的命名:
- Button1
- Input_field
- div_container
```

### 7.2 契约设计

- 明确定义元素状态
- 添加必要的约束
- 编写清晰的文档

```yucheng
元素 提交按钮 {
    状态 {
        default,
        loading,
        disabled
    }
    保证 {
        若 状态 == loading，则 显示加载图标;
        若 状态 == disabled，则 不可点击;
    }
}
```

### 7.3 布局建议

- 使用容器组织相关元素
- 保持合理的间距
- 考虑响应式设计

## 八、故障排查

### 8.1 常见问题

**问题1: 四文件生成失败**
```
原因: 元素属性不完整
解决: 检查所有必填属性是否设置
```

**问题2: 元素无法选中**
```
原因: 元素被锁定
解决: 取消锁定状态
```

**问题3: 撤销功能不工作**
```
原因: 历史记录未保存
解决: 确保每次修改后调用saveToHistory()
```

## 九、技术架构

### 9.1 前端组件

- **UiDesigner.vue**: 主设计器组件
- **工具栏**: 元素添加、操作按钮
- **画布**: SVG/Canvas渲染
- **属性面板**: 元素属性编辑

### 9.2 后端模块

- **ui_designer.rs**: 核心数据模型
- **FourFilesGenerator**: 四文件生成器
- **Tauri命令**: 前后端通信

### 9.3 数据流

```
用户操作 → Vue组件 → Tauri命令 → Rust后端 → 四文件生成
```

## 十、参考资料

- [可视化架构设计系统](72-可视化架构设计系统.md)
- [界面系统详解](05-界面系统详解.md)
- [AI编程辅助系统](34-AI编程辅助系统.md)

---

**文档版本**: 1.0-alpha  
**最后更新**: 2026-02-09  
**维护者**: 御程开发团队
