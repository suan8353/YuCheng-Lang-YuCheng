# 权限提升与管理员模式

## 概述

御程语言提供了跨平台的权限提升功能，允许程序在需要时请求管理员权限。这对于需要访问系统资源或执行特权操作的应用程序非常重要。

## API函数

### 1. 是管理员() / is_admin()

检查当前进程是否以管理员权限运行。

**语法**:
```yucheng
变量 is_admin: 布尔 = 是管理员()
```

**返回值**: 布尔值
- `真`: 当前进程拥有管理员权限
- `假`: 当前进程是普通用户权限

**平台实现**:
- **Windows**: 检查是否能写入系统目录
- **Linux/macOS**: 检查UID是否为0 (root)

**示例**:
```yucheng
如果 是管理员() {
    输出("当前拥有管理员权限")
} 否则 {
    输出("当前是普通用户权限")
}
```

### 2. 请求管理员权限() / request_admin()

请求管理员权限并重新启动程序。

**语法**:
```yucheng
请求管理员权限()
```

**行为**:
1. 显示权限提升对话框
2. 用户确认后，程序以管理员身份重新启动
3. 如果成功，当前进程会退出（不会返回）
4. 如果失败或用户拒绝，抛出错误

**平台实现**:
- **Windows**: 使用PowerShell的`Start-Process -Verb RunAs`触发UAC对话框
- **Linux**: 尝试使用`pkexec`（图形界面）或`sudo`（命令行）
- **macOS**: 使用`osascript`调用AppleScript请求权限

**示例**:
```yucheng
函数 主函数() {
    如果 !是管理员() {
        输出("需要管理员权限，正在请求...")
        尝试 {
            请求管理员权限()
            // 如果成功，程序会重启，不会执行到这里
        } 捕获 error {
            输出("权限请求失败: " + 转文本(error))
            返回
        }
    }
    
    // 这里的代码会在管理员权限下执行
    输出("现在拥有管理员权限")
    设置CPU频率(2800)  // 需要管理员权限的操作
}
```

### 3. 提升权限运行(命令) / elevate_and_run(command)

以管理员权限运行指定的命令。

**语法**:
```yucheng
变量 success: 布尔 = 提升权限运行(命令: 文本)
```

**参数**:
- `命令`: 要执行的命令字符串

**返回值**: 布尔值
- `真`: 命令执行成功
- `假`: 命令执行失败

**平台实现**:
- **Windows**: 使用PowerShell的`Start-Process -Verb RunAs -Wait`
- **Linux/macOS**: 使用`sudo`

**示例**:
```yucheng
// Windows: 查看系统信息
变量 result = 提升权限运行("systeminfo")
如果 result {
    输出("命令执行成功")
} 否则 {
    输出("命令执行失败")
}

// Linux: 安装软件包
变量 result = 提升权限运行("apt-get install -y vim")
```

## 使用场景

### 1. 硬件控制

硬件控制操作（如设置CPU频率、分配GPU内存等）需要管理员权限：

```yucheng
函数 主函数() {
    // 检查权限
    如果 !是管理员() {
        输出("硬件控制需要管理员权限")
        请求管理员权限()
        返回  // 程序会重启
    }
    
    // 执行硬件控制操作
    设置CPU频率(2800)
    分配GPU内存(1024 * 1024 * 100)
}
```

### 2. 系统配置

修改系统配置或安装服务：

```yucheng
函数 安装服务() {
    如果 !是管理员() {
        输出("安装服务需要管理员权限")
        请求管理员权限()
        返回
    }
    
    // 安装服务
    提升权限运行("sc create MyService binPath= C:\\path\\to\\service.exe")
}
```

### 3. 文件系统操作

访问受保护的系统目录：

```yucheng
函数 清理系统临时文件() {
    如果 !是管理员() {
        请求管理员权限()
        返回
    }
    
    // 清理系统临时文件
    提升权限运行("del /q /f C:\\Windows\\Temp\\*")
}
```

## 最佳实践

### 1. 最小权限原则

只在必要时请求管理员权限：

```yucheng
函数 主函数() {
    // 先执行不需要权限的操作
    变量 config = 读取配置()
    变量 data = 处理数据(config)
    
    // 只在需要时请求权限
    如果 需要硬件控制(config) {
        如果 !是管理员() {
            请求管理员权限()
            返回
        }
        执行硬件控制(data)
    }
}
```

### 2. 用户友好的提示

在请求权限前给用户清晰的说明：

```yucheng
函数 主函数() {
    如果 !是管理员() {
        输出("=== 需要管理员权限 ===")
        输出("此程序需要管理员权限来执行以下操作：")
        输出("1. 设置CPU频率")
        输出("2. 分配GPU内存")
        输出("3. 配置DMA传输")
        输出("")
        输出("程序将重新启动并请求权限...")
        输出("请在UAC对话框中点击\"是\"")
        输出("")
        
        // 给用户时间阅读
        休眠(3000)
        
        请求管理员权限()
        返回
    }
    
    // 执行需要权限的操作
}
```

### 3. 错误处理

妥善处理权限请求失败的情况：

```yucheng
函数 主函数() {
    如果 !是管理员() {
        尝试 {
            请求管理员权限()
        } 捕获 error {
            输出("无法获取管理员权限: " + 转文本(error))
            输出("程序将以受限模式运行")
            输出("某些功能可能不可用")
            
            // 继续以受限模式运行
            运行受限模式()
            返回
        }
    }
    
    // 完整功能模式
    运行完整模式()
}
```

### 4. 避免重复请求

使用标志避免无限循环：

```yucheng
函数 主函数() {
    // 检查命令行参数，避免重复请求
    变量 args = 获取命令行参数()
    变量 already_elevated = 列表包含(args, "--elevated")
    
    如果 !是管理员() && !already_elevated {
        输出("请求管理员权限...")
        请求管理员权限()
        返回
    }
    
    如果 !是管理员() && already_elevated {
        输出("错误：权限提升失败")
        返回
    }
    
    // 执行需要权限的操作
}
```

## 安全注意事项

### 1. 审计和日志

记录所有权限提升操作：

```yucheng
函数 请求权限并记录() {
    日志("尝试请求管理员权限")
    
    尝试 {
        请求管理员权限()
    } 捕获 error {
        日志("权限请求失败: " + 转文本(error))
        抛出 error
    }
}
```

### 2. 验证操作

在执行特权操作前进行验证：

```yucheng
函数 安全的硬件控制(频率: 整数) {
    // 验证参数
    如果 频率 < 800 || 频率 > 5000 {
        抛出 "无效的CPU频率"
    }
    
    // 验证权限
    如果 !是管理员() {
        抛出 "需要管理员权限"
    }
    
    // 执行操作
    设置CPU频率(频率)
}
```

### 3. 限制权限范围

只在特定代码块中使用权限：

```yucheng
函数 主函数() {
    // 普通操作
    变量 data = 加载数据()
    
    // 需要权限的操作
    如果 需要特权操作() {
        执行特权操作()
    }
    
    // 继续普通操作
    保存结果(data)
}
```

## 平台差异

### Windows
- 使用UAC（用户账户控制）对话框
- 需要用户点击"是"确认
- 支持图形界面和命令行

### Linux
- 优先使用`pkexec`（图形界面）
- 回退到`sudo`（命令行）
- 可能需要输入密码

### macOS
- 使用AppleScript对话框
- 需要输入管理员密码
- 支持Touch ID（如果可用）

## 故障排除

### 问题1: 权限请求失败

**原因**: 用户拒绝或系统策略限制

**解决方案**:
```yucheng
尝试 {
    请求管理员权限()
} 捕获 error {
    输出("权限请求失败，可能的原因：")
    输出("1. 用户拒绝了权限请求")
    输出("2. 系统策略禁止权限提升")
    输出("3. 当前用户不在管理员组")
}
```

### 问题2: 程序重启后参数丢失

**解决方案**: 命令行参数会自动传递给重启的进程

```yucheng
// 原始启动: yucheng run myapp.ycs --config=prod
// 重启后: yucheng run myapp.ycs --config=prod (参数保留)
```

### 问题3: Linux上sudo需要密码

**解决方案**: 配置sudoers或使用pkexec

```bash
# 配置sudoers允许无密码sudo
sudo visudo
# 添加: username ALL=(ALL) NOPASSWD: /path/to/yucheng
```

## 示例程序

完整示例请参考：
- `examples/28-admin-privileges.ycs` - 完整的权限管理示例
- `examples/29-request-admin-simple.ycs` - 简单的权限请求示例

## 相关文档

- [硬件控制能力](53-真正的硬件控制能力.md)
- [系统API与跨平台支持](37-系统API与跨平台支持.md)
- [安全边界与MVP定义](21-安全边界与MVP定义.md)
