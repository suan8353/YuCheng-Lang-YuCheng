# 御程语言 - 语法总览

> **实现状态**: ✅ 完整实现
> - ✅ 所有语法特性已在编译器中实现
> - ✅ 与 03-语法详解.md 保持一致
> 
> 本文档是御程（YuCheng）语言的完整语法参考手册，涵盖所有已实现的语法特性。

## 目录

1. [文件类型](#1-文件类型)
2. [基础语法](#2-基础语法)
3. [数据类型](#3-数据类型)
4. [变量声明](#4-变量声明)
5. [运算符](#5-运算符)
6. [控制流](#6-控制流)
7. [循环结构](#7-循环结构)
8. [函数定义](#8-函数定义)
9. [自定义类型](#9-自定义类型)
10. [结果类型](#10-结果类型)
11. [模式匹配](#11-模式匹配)
12. [御程特有语法](#12-御程特有语法)
13. [标准库函数](#13-标准库函数)
14. [输入输出](#14-输入输出)

---

## 1. 文件类型

| 扩展名 | 用途 | 说明 |
|-------|------|------|
| `.yc` | 规格定义 | 接口声明文件 |
| `.yci` | 逻辑实现 | 函数实现文件 |
| `.ycl` | 链接配置 | 项目配置文件（JSON格式） |
| `.ycv` | 界面视图 | UI定义文件 |
| `.ycs` | 单文件模式 | 教学/原型开发用 |

---

## 2. 基础语法

### 2.1 注释

```御程
// 单行注释

/*
 * 多行注释
 * 可以跨越多行
 */
```

### 2.2 标识符

- 支持中文标识符
- 支持英文标识符
- 支持下划线 `_`
- 不能以数字开头

```御程
var 用户名 = "张三"
var userName = "张三"
var user_name = "张三"
```

### 2.3 关键字

御程语言支持中英文双语关键字：

| 中文 | 英文 | 说明 |
|------|------|------|
| `纯函数` | `pure` | 纯函数声明 |
| `查询` | `query` | 查询函数声明 |
| `副作用` | `effect` | 副作用函数声明 |
| `如果` | `if` | 条件判断 |
| `否则` | `else` | 否则分支 |
| `否则如果` | `elif` | 否则如果分支 |
| `当` | `while` | 条件循环 |
| `循环` | `for` | 遍历循环 |
| `在` | `in` | 循环迭代 |
| `返回` | `return` | 返回语句 |
| `中断` | `break` | 跳出循环 |
| `继续` | `continue` | 继续下一次循环 |
| `匹配` | `match` | 模式匹配 |
| `真` | `true` | 布尔真值 |
| `假` | `false` | 布尔假值 |
| `空` | `null` | 空值 |
| `且` | `and` | 逻辑与 |
| `或` | `or` | 逻辑或 |
| `非` | `not` | 逻辑非 |
| `新建` | `new` | 创建对象 |
| `自己` | `self` | 当前对象引用 |
| `接口` | `interface` | 接口定义 |
| `类` | `class` | 类定义 |
| `抛出` | `throw` | 抛出错误 |
| `导入` | `import` | 导入模块 |
| `导出` | `export` | 导出声明 |
| `外部` | `external` | 外部库声明 |
| `库` | `lib` | 库声明 |
| `变量` | `var` | 变量声明 |
| `函数` | `func` | 函数声明 |
| `若` | `when` | 条件表达式 |
| `则` | `then` | 条件表达式 |
| `选择` | `select` | 选择表达式 |
| `其他` | `default` | 默认分支 |
| `步进` | `step` | 范围步长 |

---

## 3. 数据类型

### 3.1 基本类型

| 类型 | 关键字 | 示例 |
|------|--------|------|
| 整数 | `整数` / `int` | `42`, `-100`, `0` |
| 小数 | `小数` / `float` | `3.14`, `-0.5` |
| 文本 | `文本` / `string` | `"你好"`, `"Hello"` |
| 布尔 | `布尔` / `bool` | `真`, `假` |
| 空值 | `空` / `null` | `空` |

### 3.2 复合类型

| 类型 | 语法 | 示例 |
|------|------|------|
| 列表 | `[元素, ...]` | `[1, 2, 3]` |
| 映射 | `{键: 值, ...}` | `{"名字": "张三"}` |
| 自定义类型 | `类型 名称 { ... }` | 见第9节 |
| 结果类型 | 标准库函数 | 见第10节 |

---

## 4. 变量声明

### 4.1 可变变量

```御程
var 名字 = "张三"           // 类型推断
var 年龄: 整数 = 25         // 显式类型
var 列表 = [1, 2, 3]        // 列表
```

### 4.2 常量

```御程
const 圆周率 = 3.14159
const 最大值: 整数 = 9999
```

---

## 5. 运算符

### 5.1 算术运算符

| 运算符 | 说明 | 示例 |
|--------|------|------|
| `+` | 加法/字符串连接 | `1 + 2`, `"a" + "b"` |
| `-` | 减法 | `5 - 3` |
| `*` | 乘法 | `4 * 2` |
| `/` | 除法 | `10 / 3` |
| `%` | 取余 | `10 % 3` |

### 5.2 比较运算符

| 运算符 | 说明 | 示例 |
|--------|------|------|
| `==` | 等于 | `a == b` |
| `<>` 或 `!=` | 不等于 | `a <> b` |
| `>` | 大于 | `a > b` |
| `<` | 小于 | `a < b` |
| `>=` | 大于等于 | `a >= b` |
| `<=` | 小于等于 | `a <= b` |

### 5.3 逻辑运算符

| 运算符 | 说明 | 示例 |
|--------|------|------|
| `且` / `and` | 逻辑与 | `a 且 b` |
| `或` / `or` | 逻辑或 | `a 或 b` |
| `非` / `not` / `!` | 逻辑非 | `非 a` |

### 5.4 复合赋值运算符

| 运算符 | 说明 | 示例 |
|--------|------|------|
| `+=` | 加法赋值 | `x += 5` |
| `-=` | 减法赋值 | `x -= 3` |
| `*=` | 乘法赋值 | `x *= 2` |
| `/=` | 除法赋值 | `x /= 4` |
| `%=` | 取余赋值 | `x %= 3` |

### 5.5 范围运算符

| 运算符 | 说明 | 示例 |
|--------|------|------|
| `..` | 不包含结束值 | `1..5` → `[1,2,3,4]` |
| `...` | 包含结束值 | `1...5` → `[1,2,3,4,5]` |

### 5.6 御程特有运算符

| 运算符 | 说明 | 示例 |
|--------|------|------|
| `\|>` | 管道操作符 | `5 \|> 平方()` |
| `??` | 空值合并 | `值 ?? "默认"` |
| `?.` | 安全访问 | `用户?.名字` |
| `?` | 错误传播 | `结果?` |

---

## 6. 控制流

### 6.1 条件判断

```御程
// 基本 if-else
如果 年龄 >= 18 {
    控制台 => "成年人"
} 否则 {
    控制台 => "未成年人"
}

// 多条件
如果 分数 >= 90 {
    等级 = "优秀"
} 否则如果 分数 >= 60 {
    等级 = "及格"
} 否则 {
    等级 = "不及格"
}
```

### 6.2 条件表达式（御程特有）

```御程
// 若...则...否则 表达式
var 状态 = 若 分数 >= 60 则 "及格" 否则 "不及格"

// 也支持 如果...则...否则 表达式（等价语法）
var 状态2 = 如果 分数 >= 60 则 "及格" 否则 "不及格"
```

### 6.3 选择表达式（御程特有）

```御程
var 等级 = 选择 {
    分数 >= 90 => "优秀"
    分数 >= 80 => "良好"
    分数 >= 60 => "及格"
    其他 => "不及格"
}
```

---

## 7. 循环结构

### 7.1 范围循环

```御程
// 不包含结束值
循环 i 在 1..5 {
    控制台 => i    // 输出 1,2,3,4
}

// 包含结束值
循环 i 在 1...5 {
    控制台 => i    // 输出 1,2,3,4,5
}

// 带步长
循环 i 在 0..10 步进 2 {
    控制台 => i    // 输出 0,2,4,6,8
}

// 负步长（倒序）
循环 i 在 10..0 步进 -1 {
    控制台 => i    // 输出 10,9,8,...,1
}

// 从...到 语法（等价于范围循环）
循环 i 从 0 到 10 {
    控制台 => i    // 输出 0,1,2,...,10
}
```

### 7.1.1 重复循环

```御程
// 重复N次（不需要变量）
循环 100 次 {
    控制台 => "执行100次"
}

// 重复变量次
var 次数 = 50
循环 次数 次 {
    控制台 => "执行50次"
}
```

### 7.2 列表遍历

```御程
var 水果 = ["苹果", "香蕉", "橙子"]
循环 项 在 水果 {
    控制台 => 项
}
```

### 7.3 条件循环

```御程
当 计数 < 100 {
    计数 = 计数 + 1
}
```

### 7.4 循环控制

```御程
循环 i 在 1..10 {
    如果 i == 3 {
        继续        // 跳过本次迭代
    }
    如果 i == 7 {
        中断        // 跳出循环
    }
    控制台 => i
}
```

---

## 8. 函数定义

### 8.1 函数分类

御程语言强制函数分类，提高代码可预测性：

| 分类 | 关键字 | 特点 |
|------|--------|------|
| 纯函数 | `纯函数` | 无副作用，相同输入总是相同输出 |
| 查询 | `查询` | 只读操作，不修改状态 |
| 副作用 | `副作用` | 可修改状态、执行I/O |

### 8.2 函数声明

```御程
// 纯函数
纯函数 func 加法(a: 整数, b: 整数) -> 整数 {
    返回 a + b
}

// 查询函数
查询 func 获取用户(id: 整数) -> 用户 {
    返回 数据库.查询(id)
}

// 副作用函数
副作用 func 保存数据(数据: 文本) {
    文件.写入(数据)
}
```

### 8.3 递归函数

```御程
纯函数 func 阶乘(n: 整数) -> 整数 {
    如果 n <= 1 {
        返回 1
    }
    返回 n * 阶乘(n - 1)
}
```

---

## 9. 自定义类型

### 9.1 类型定义

```御程
类型 用户 {
    名字: 文本
    年龄: 整数
}

类型 点 {
    x: 整数
    y: 整数
}

类型 地址 {
    城市: 文本
    街道: 文本
}
```

### 9.2 实例创建

```御程
var 张三 = 用户("张三", 25)
var 原点 = 点(0, 0)
var 地址1 = 地址("北京", "长安街")
```

### 9.3 字段访问与修改

```御程
// 访问字段
控制台 => 张三.名字
控制台 => 张三.年龄

// 修改字段
张三.年龄 = 26
```

---

## 10. 结果类型

御程语言内置结果类型，用于优雅的错误处理：

**重要说明**：`成功` 和 `失败` 是标准库函数，不是关键字。它们通过函数调用的形式使用。

### 10.1 创建结果

```御程
// 成功结果（使用标准库函数）
var 成功结果 = 成功(42)

// 失败结果（使用标准库函数）
var 失败结果 = 失败("出错了")
```

### 10.2 检查结果

```御程
是成功(结果)    // 返回布尔值
是失败(结果)    // 返回布尔值
```

### 10.3 解包结果

```御程
解包(结果)              // 解包成功值，失败时报错
解包或(结果, 默认值)    // 解包成功值，失败时返回默认值
```

---

## 11. 模式匹配

### 11.1 基本匹配

```御程
匹配 状态码 {
    200 => 控制台 => "成功"
    404 => 控制台 => "未找到"
    500 => 控制台 => "服务器错误"
    _ => 控制台 => "未知状态"
}
```

### 11.2 变量绑定

```御程
匹配 值 {
    n => 控制台 => "匹配到:", n
}
```

### 11.3 结果类型匹配

```御程
// 使用函数检查Result类型
如果 是成功(结果) {
    var v = 解包(结果)
    控制台 => "成功值:", v
} 否则 {
    控制台 => "错误: 操作失败"
}

// 或使用解包函数
var 值 = 解包或(结果, 默认值)
```

---

## 12. 御程特有语法

### 12.1 管道操作符 `|>`

将左侧表达式的值作为右侧函数的第一个参数：

```御程
// 链式处理
var 结果 = 5 |> 平方() |> 加一() |> 乘二()

// 等价于
var 结果 = 乘二(加一(平方(5)))
```

### 12.2 空值合并 `??`

当左侧为空时返回右侧值：

```御程
var 名字 = 用户名 ?? "匿名"
var 值 = 甲 ?? 乙 ?? 丙    // 链式空值合并
```

### 12.3 安全访问 `?.`

安全访问可能为空的对象成员：

```御程
var 城市 = 用户?.地址?.城市    // 任何一级为空则返回空
var 名字 = 用户?.名字 ?? "未知"  // 配合空值合并使用
```

### 12.4 包含范围 `...`

```御程
循环 i 在 1...5 { }    // 1,2,3,4,5（包含5）
循环 i 在 1..5 { }     // 1,2,3,4（不包含5）
```

### 12.5 步长范围

```御程
循环 i 在 0..100 步进 2 { }     // 0,2,4,6...98
循环 i 在 10..0 步进 -1 { }     // 10,9,8...1
```

### 12.6 条件表达式

```御程
var 状态 = 若 条件 则 值1 否则 值2
```

### 12.7 选择表达式

```御程
var 结果 = 选择 {
    条件1 => 值1
    条件2 => 值2
    其他 => 默认值
}
```

---

## 13. 标准库函数

### 13.1 类型转换

| 函数 | 说明 | 示例 |
|------|------|------|
| `转文本(值)` | 转换为文本 | `转文本(42)` → `"42"` |
| `转整数(值)` | 转换为整数 | `转整数("42")` → `42` |
| `转小数(值)` | 转换为小数 | `转小数("3.14")` → `3.14` |
| `获取类型(值)` | 获取类型名 | `获取类型(42)` → `"整数"` |

### 13.2 数学函数

| 函数 | 说明 |
|------|------|
| `绝对值(数)` | 返回绝对值 |
| `最大值(a, b)` | 返回较大值 |
| `最小值(a, b)` | 返回较小值 |
| `向下取整(数)` | 向下取整 |
| `向上取整(数)` | 向上取整 |
| `四舍五入(数)` | 四舍五入 |
| `幂(底数, 指数)` | 幂运算 |
| `平方根(数)` | 平方根 |

### 13.3 列表函数

| 函数 | 说明 |
|------|------|
| `长度(列表)` | 获取长度 |
| `追加(列表, 元素)` | 追加元素（返回新列表） |
| `查找(列表, 元素)` | 查找索引 |
| `包含(列表, 元素)` | 检查是否包含 |
| `反转(列表)` | 反转列表 |

### 13.4 字符串函数

| 函数 | 说明 |
|------|------|
| `字符串长度(文本)` | 获取长度 |
| `去空格(文本)` | 去除首尾空格 |
| `转大写(文本)` | 转为大写 |
| `转小写(文本)` | 转为小写 |
| `分割(文本, 分隔符)` | 分割字符串 |
| `连接(列表, 分隔符)` | 连接字符串 |

### 13.5 结果类型函数

| 函数 | 说明 | 类型 |
|------|------|------|
| `成功(值)` | 创建成功结果 | 标准库函数 |
| `失败(值)` | 创建失败结果 | 标准库函数 |
| `是成功(结果)` | 检查是否成功 | 标准库函数 |
| `是失败(结果)` | 检查是否失败 | 标准库函数 |
| `解包(结果)` | 解包成功值 | 标准库函数 |
| `解包或(结果, 默认值)` | 解包或返回默认值 | 标准库函数 |
| `期望(结果, 消息)` | 解包并显示自定义错误 | 标准库函数 |

**注意**：Result类型通过标准库函数实现，不再使用关键字。这降低了学习难度，减少了命名冲突。

---

## 14. 输入输出

### 14.1 控制台输出

```御程
控制台 => "你好，世界"
控制台 => "结果是：", 计算结果
控制台 => "名字:", 名字, "年龄:", 年龄
```

### 14.2 控制台输入

```御程
控制台 <= 用户输入
```

### 14.3 日志输出

```御程
// 日志级别（从低到高）
追踪("详细调试信息")           // [追踪] 详细调试信息
调试("变量值：", 变量)         // [调试] 变量值：xxx
信息("操作完成")               // [信息] 操作完成
日志("一般信息")               // [信息] 一般信息（别名）
警告("注意：", 警告内容)       // [警告] 注意：xxx
错误日志("失败：", 错误信息)   // [错误] 失败：xxx（输出到stderr）
```

---

## 15. 单文件模式

单文件模式（`.ycs`）用于教学和快速原型开发：

```御程
// hello.ycs

#规格
纯函数 func 加法(a: 整数, b: 整数) -> 整数
副作用 func 主函数()

#实现
纯函数 func 加法(a: 整数, b: 整数) -> 整数 {
    返回 a + b
}

副作用 func 主函数() {
    var 结果 = 加法(1, 2)
    控制台 => "1 + 2 = ", 结果
}

#视图
窗口 主窗口 {
    标题: "Hello YuCheng"
    
    按钮 {
        文字: "计算"
        点击 => 主函数()
    }
}
```

---

## 附录：完整示例

```御程
/*
 * 御程语言完整示例
 */

// 自定义类型
类型 学生 {
    名字: 文本
    分数: 整数
}

// 纯函数：评级
纯函数 func 评级(分数: 整数) -> 文本 {
    返回 选择 {
        分数 >= 90 => "A"
        分数 >= 80 => "B"
        分数 >= 70 => "C"
        分数 >= 60 => "D"
        其他 => "F"
    }
}

// 纯函数：计算平均分
纯函数 func 平均分(学生列表: 列表) -> 整数 {
    var 总分 = 0
    循环 学生 在 学生列表 {
        总分 = 总分 + 学生.分数
    }
    返回 总分 / 长度(学生列表)
}

// 主函数
副作用 func 主函数() {
    // 创建学生列表
    var 学生们 = [
        学生("张三", 85),
        学生("李四", 92),
        学生("王五", 78)
    ]
    
    // 遍历并显示信息
    循环 s 在 学生们 {
        var 名字 = s?.名字 ?? "未知"
        var 等级 = s.分数 |> 评级()
        var 状态 = 若 s.分数 >= 60 则 "通过" 否则 "未通过"
        
        控制台 => "学生:", 名字, "等级:", 等级, "状态:", 状态
    }
    
    // 计算平均分
    var 平均 = 平均分(学生们)
    控制台 => "班级平均分:", 平均
}
```

---

## 版本信息

- 文档版本：1.2
- 语言版本：0.1.0
- 更新日期：2026-01-16
- 测试覆盖：849 个测试用例全部通过
- Parser 语法完整性：100%
- 修正说明：已根据代码实现修正关键字表和语法说明，确保文档与代码一致
