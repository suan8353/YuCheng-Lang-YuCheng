# YuCheng 语言 - 架构文档

## 1. 系统总览

YuCheng（御程）语言采用"三层六模块"架构，实现从代码输入到可视化输出的完整闭环。

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户层 (User Layer)                       │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐        │
│  │  .yc 文件 │  │ .yci 文件 │  │ .ycl 文件 │  │ .ycv 文件 │        │
│  │ 规格定义  │  │ 逻辑实现  │  │ 链接配置  │  │ 界面视图  │        │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘        │
└───────┼─────────────┼─────────────┼─────────────┼───────────────┘
        │             │             │             │
        ▼             ▼             ▼             ▼
┌─────────────────────────────────────────────────────────────────┐
│                      编译层 (Compiler Layer)                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │ 符号预处理器  │─▶│  词法分析器   │─▶│  语法分析器   │          │
│  │  Sanitizer   │  │    Lexer     │  │    Parser    │          │
│  └──────────────┘  └──────────────┘  └──────┬───────┘          │
│                                             │                   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────▼───────┐          │
│  │  代码生成器   │◀─│  链接检查器   │◀─│  语义分析器   │          │
│  │  Generator   │  │    Linker    │  │   Analyzer   │          │
│  └──────┬───────┘  └──────────────┘  └──────────────┘          │
└─────────┼───────────────────────────────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────────────────────────────┐
│                      运行层 (Runtime Layer)                      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │  内存模拟器   │  │  图表渲染器   │  │  JSON生成器   │          │
│  │  Simulator   │  │   Renderer   │  │  Reporter    │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└─────────────────────────────────────────────────────────────────┘
```

## 2. 文件扩展名体系

### 2.1 四文件强制闭环

| 扩展名 | 全称 | 职责 | 强制性 |
|-------|------|------|--------|
| `.yc` | YuCheng Specification | 规格/接口声明 | 必须 |
| `.yci` | YuCheng Implementation | 逻辑实现 | 必须 |
| `.ycl` | YuCheng Linkage | 链接配置 | 必须 |
| `.ycv` | YuCheng View | 界面视图 | 可选 |

### 2.2 命名规范

```
项目名.ycl          # 项目链接配置（入口）
├── 模块A.yc        # 模块A规格
├── 模块A.yci       # 模块A实现
├── 模块A.ycv       # 模块A界面（可选）
├── 模块B.yc        # 模块B规格
└── 模块B.yci       # 模块B实现
```

### 2.3 文件依赖关系

```
project.ycl (总控)
    │
    ├── module_a.yc ◄──── module_a.yci
    │       │
    │       └── module_a.ycv (可选)
    │
    └── module_b.yc ◄──── module_b.yci
```

## 3. 编译器架构

### 3.1 编译流程

```
源代码 ──▶ 符号净化 ──▶ 词法分析 ──▶ 语法分析 ──▶ 语义分析
                                                    │
    ┌───────────────────────────────────────────────┘
    │
    ▼
链接检查 ──▶ 中间表示(IR) ──▶ 优化 ──▶ 代码生成
                │
                ├──▶ 可执行文件 (.exe)
                ├──▶ 动态链接库 (.dll/.so)
                └──▶ 内存快照 (.json)
```

### 3.2 符号预处理器

在正式编译前，将全角符号映射为半角符号：

```
输入: 如果 （年龄 ＞ 18） ｛
    打印（"成年"）；
｝

输出: 如果 (年龄 > 18) {
    打印("成年");
}
```

映射规则表：

| 全角符号 | 半角符号 | 说明 |
|---------|---------|------|
| （ ） | ( ) | 括号 |
| ｛ ｝ | { } | 花括号 |
| ［ ］ | [ ] | 方括号 |
| ， | , | 逗号 |
| ； | ; | 分号 |
| ： | : | 冒号 |
| ＝ | = | 等号 |
| ＜ ＞ | < > | 尖括号 |
| " " | " | 引号 |

### 3.3 链接检查器

强制校验三个条件：

1. **定义完整性**：`.yc` 中声明的所有函数必须在 `.yci` 中实现
2. **实现合法性**：`.yci` 中不能出现 `.yc` 未声明的函数
3. **链接一致性**：`.ycl` 中引用的模块必须存在

```json
// 错误报告示例
{
  "error_type": "LINK_ERROR",
  "message": "函数 '保存数据' 已在 data.yc 中声明，但未在 data.yci 中实现",
  "location": {
    "file": "data.yc",
    "line": 15
  }
}
```

## 4. 运行时架构

### 4.1 执行引擎

御程语言支持两种执行引擎：

#### 4.1.1 树遍历解释器 (TreeWalk Interpreter)

**位置**: `compiler/src/interpreter.rs`

**特点**:
- 直接遍历 AST 执行，实现简单
- 启动速度快，适合开发和调试
- 支持函数重载、尾调用优化、内联缓存
- 集成异步运行时（Tokio）支持异步函数
- 可选集成内存透视和调试器

**核心组件**:
- `Value` 枚举：运行时值类型（整数、浮点、字符串、列表、映射、函数、结构体、结果类型、可选类型、指针类型等）
- `Interpreter` 结构：解释器主体，包含作用域栈、函数表、类型定义表、标准库等
- 执行方法：`run()` 执行程序，`eval_stmt()` 执行语句，`eval_expr()` 执行表达式

#### 4.1.2 字节码虚拟机 (Bytecode VM)

**位置**: `compiler/src/bytecode.rs`

**特点**:
- 将 AST 编译为字节码后执行，性能更高
- 适合生产环境
- 栈式虚拟机设计
- 支持常量池、局部变量、全局变量

详见 [字节码虚拟机文档](68-字节码虚拟机.md)

### 4.2 内存模拟器

模拟真实内存布局，支持多种指针类型：

| 指针类型 | 关键字 | 特点 | 实现 |
|---------|--------|------|------|
| Box指针 | `Box<T>` | 独占所有权，堆分配 | `Value::BoxPtr(Box<Value>)` |
| Rc指针 | `Rc<T>` | 引用计数，共享所有权 | `Value::RcPtr(Rc<RefCell<Value>>)` |
| Mutex | `Mutex<T>` | 互斥锁，线程安全 | `Value::Mutex(Arc<Mutex<Value>>)` |
| RwLock | `RwLock<T>` | 读写锁，多读单写 | `Value::RwLock(Arc<RwLock<Value>>)` |
| Channel | `Channel<T>` | 通道，线程间通信 | `Value::Channel(Arc<ChannelInner>)` |
| AtomicInt | `AtomicInt` | 原子整数 | `Value::AtomicInt(Arc<AtomicI64>)` |

**注意**: 内存模拟器是**观察工具**，用于开发期观察内存状态，不是安全保证。详见 [安全边界文档](21-安全边界.md)

### 4.3 双输出通道

```
运行时
   │
   ├──▶ 图表通道 ──▶ IDE 右侧面板 (给人看)
   │
   └──▶ JSON 通道 ──▶ memory_snapshot.json (给 AI 看)
```

### 4.4 标准库集成

解释器和字节码虚拟机共享相同的标准库（`stdlib.rs`），确保行为一致性：

- 数学函数：`绝对值`, `四舍五入`, `最大值`, `最小值`, `随机整数`, `正弦`, `余弦`, `平方根`
- 文本函数：`长度`, `截取`, `替换`, `分割`, `包含`, `大写`, `小写`, `去空格`
- 列表函数：`添加`, `获取`, `长度`, `映射`, `过滤`, `排序`, `反转`
- 类型转换：`转整数`, `转小数`, `转文本`, `转布尔`, `获取类型`
- I/O 函数：`打印`, `输入`, `读取文件`, `写入文件`, `追加文件`, `删除文件`
- 日志函数：`追踪`, `调试`, `信息`, `日志`, `警告`, `错误日志`
- 系统函数：`获取环境变量`, `执行命令`, `当前时间戳`, `获取操作系统`, `获取用户名`

## 5. IDE 架构

### 5.1 界面布局

```
┌─────────────────────────────────────────────────────────────┐
│  菜单栏  │  工具栏                                           │
├─────────┼───────────────────────────────┬───────────────────┤
│         │                               │                   │
│  文件   │      代码编辑区                │   内存透视图       │
│  树     │      (支持语法高亮)            │   (实时图表)       │
│         │                               │                   │
├─────────┴───────────────────────────────┴───────────────────┤
│  控制台输出  │  问题列表  │  JSON 报告预览                    │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 文件图标

| 扩展名 | 图标颜色 | 含义 |
|-------|---------|------|
| `.yc` | 🔵 蓝色 | 规格/契约 |
| `.yci` | 🟢 绿色 | 实现/代码 |
| `.ycl` | 🟡 黄色 | 链接/配置 |
| `.ycv` | 🟣 紫色 | 视图/界面 |

## 6. 技术选型

| 组件 | 推荐技术 | 备选方案 |
|------|---------|---------|
| 编译器核心 | Rust | Go |
| IDE 框架 | Tauri + Vue | Electron |
| 图表渲染 | ECharts | D3.js |
| 界面渲染 | WebView2 | SDL2 |
| 数据格式 | JSON | MessagePack |

## 7. 扩展性设计

### 7.1 未来扩展名预留

| 扩展名 | 用途 |
|-------|------|
| `.yct` | YuCheng Test (测试文件) |
| `.ycc` | YuCheng Config (配置文件) |
| `.ycd` | YuCheng Document (文档) |
| `.ycm` | YuCheng Module (模块包) |

### 7.2 插件系统

```
plugins/
├── syntax-highlight/    # 语法高亮插件
├── ai-assistant/        # AI 辅助插件
├── theme-dark/          # 主题插件
└── export-python/       # 导出为 Python 插件
```

### 7.3 多语言互操作

通过 C ABI 兼容层，支持与其他语言交互：

```
YuCheng源码 ──▶ 编译器 ──▶ C 兼容 DLL ──▶ Python/Go/Rust 调用
```
